<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxGPT Pro</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background: #f8f9ff; }
        #chat-history { max-height: 70vh; overflow-y: auto; }
        .msg-box { padding: 1rem; border-radius: 12px; margin: 0.7rem 0; }
    </style>
</head>

<body class="flex flex-col items-center">

    <h1 class="text-4xl font-bold text-indigo-600 mt-6">TaxGPT Pro</h1>

    <!-- CHAT HISTORY -->
    <div id="chat-history" class="w-full max-w-3xl mt-8 bg-white shadow p-4 rounded-lg"></div>

    <!-- INPUT -->
    <form id="chat-form" class="w-full max-w-3xl flex mt-4">
        <input id="query-input" 
               class="flex-grow p-3 border rounded-l-lg" 
               placeholder="Ask anythingâ€¦" />
        <button class="bg-indigo-600 text-white px-6 rounded-r-lg">Send</button>
    </form>

<script>
/* ---------------------------------------------------------------
   ðŸ”¥ FIREBASE CONFIG â€” REPLACE WITH YOURS
--------------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "<YOUR_FIREBASE_API_KEY>",
  authDomain: "<YOUR_PROJECT_ID>.firebaseapp.com",
  projectId: "<YOUR_PROJECT_ID>",
  storageBucket: "<YOUR_PROJECT_ID>.appspot.com",
  messagingSenderId: "<YOUR_SENDER_ID>",
  appId: "<YOUR_APP_ID>",
  measurementId: "<YOUR_MEASUREMENT_ID>"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let userId = null;

/* ---------------------------------------------------------------
   ðŸ”¥ SIGN IN ANONYMOUSLY
--------------------------------------------------------------- */
auth.signInAnonymously()
  .then(() => console.log("Signed in"))
  .catch(err => console.error("Auth error:", err));

auth.onAuthStateChanged(u => {
    if (!u) return;
    userId = u.uid;
    startListener();
});

/* ---------------------------------------------------------------
   ðŸ”¥ REALTIME LISTENER
--------------------------------------------------------------- */
function startListener() {
    db.collection("users")
      .doc(userId)
      .collection("consultations")
      .orderBy("timestamp")
      .onSnapshot(snap => {
          const out = document.getElementById("chat-history");
          out.innerHTML = "";

          snap.forEach(doc => {
              const d = doc.data();
              const div = document.createElement("div");
              div.className = "msg-box bg-gray-100";
              div.innerHTML = `<strong>${d.role.toUpperCase()}:</strong><br>${d.display_text}`;
              out.appendChild(div);
          });

          out.scrollTop = out.scrollHeight;
      });
}

/* ---------------------------------------------------------------
   ðŸ”¥ SAVE MESSAGE
--------------------------------------------------------------- */
function saveMessage(role, text) {
    return db.collection("users")
             .doc(userId)
             .collection("consultations")
             .add({
                 role,
                 display_text: text,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp()
             });
}

/* ---------------------------------------------------------------
   ðŸ”¥ GEMINI API CONFIG â€” REPLACE KEY
--------------------------------------------------------------- */
const GEMINI_API_KEY = "<YOUR_GEMINI_API_KEY>";
const GEMINI_MODEL = "gemini-2.0-flash";

/* ---------------------------------------------------------------
   ðŸ”¥ GEMINI CALL (FULLY LOGGED + FIXED)
--------------------------------------------------------------- */
async function callGemini(prompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

    const body = {
        contents: [{ parts: [{ text: prompt }] }]
    };

    try {
        const res = await fetch(url, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("ðŸ” GEMINI RESPONSE:", data);

        if (data.error) {
            return "âŒ Gemini Error: " + data.error.message;
        }

        return (
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "âš ï¸ No output returned from Gemini."
        );

    } catch (err) {
        console.error("âŒ Fetch error:", err);
        return "âŒ Network error calling Gemini.";
    }
}

/* ---------------------------------------------------------------
   ðŸ”¥ FORM SUBMIT
--------------------------------------------------------------- */
document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const input = document.getElementById("query-input");
    const text = input.value.trim();
    if (!text) return;

    input.value = "";

    await saveMessage("user", text);

    const reply = await callGemini(text);

    await saveMessage("model", reply);
});
</script>

</body>
</html>
