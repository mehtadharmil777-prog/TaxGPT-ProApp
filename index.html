<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxGPT Pro | Strategic Intelligence</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7' } },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ticker': 'ticker 40s linear infinite',
                        'shimmer': 'shimmer 1.5s infinite linear'
                    },
                    keyframes: {
                        ticker: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } },
                        shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body, aside, div, span, button { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }
        
        .prose h3 { font-weight: 600; font-size: 1.1em; margin-top: 1.2em; color: inherit; }
        .prose ul { list-style-type: disc; padding-left: 1.4em; margin-bottom: 1em; }
        .prose strong { font-weight: 600; color: inherit; }
        .prose table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 1em 0; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; font-size: 0.9em; }
        .dark .prose table { border-color: #27272a; }
        .prose th { background: #f8fafc; padding: 10px 14px; text-align: left; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .dark .prose th { background: #18181b; border-color: #27272a; }
        .prose td { padding: 10px 14px; border-bottom: 1px solid #e5e7eb; }
        .dark .prose td { border-color: #27272a; }

        .logo-gradient { background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); }
        .mic-active { color: #ef4444 !important; animation: pulse 1.5s infinite; }
        
        .skeleton { background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%); background-size: 800px 104px; animation: shimmer 1.5s infinite linear forwards; }
        .dark .skeleton { background: linear-gradient(to right, #1f1f23 8%, #2a2a2d 18%, #1f1f23 33%); }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #4b5563; }

        /* Gauge */
        .gauge-container { position: relative; width: 100px; height: 50px; overflow: hidden; }
        .gauge-body { width: 100px; height: 50px; background: #e5e7eb; border-radius: 50px 50px 0 0; }
        .gauge-fill { position: absolute; top: 100%; left: 0; width: 100%; height: 100%; background: #ef4444; transform-origin: center top; transform: rotate(0.25turn); transition: transform 0.5s ease-out; border-radius: 0 0 50px 50px; }
        .gauge-needle { position: absolute; bottom: 0; left: 50%; width: 2px; height: 45px; background: #1f2937; transform-origin: bottom center; transform: rotate(-90deg); transition: transform 0.5s ease-out; z-index: 10; }
    </style>
</head>
<body class="bg-white dark:bg-[#09090b] text-slate-900 dark:text-slate-50 h-screen flex overflow-hidden font-sans relative">

    <div id="toast-container" class="fixed top-14 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="sandbox-modal" class="fixed inset-0 z-[75] flex items-center justify-center bg-black/60 backdrop-blur-md px-4 hidden">
        <div class="bg-white dark:bg-[#18181b] p-6 rounded-3xl shadow-2xl w-full max-w-4xl border border-gray-200 dark:border-gray-800 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-gamepad text-blue-500"></i> Tax Sandbox</h2>
                <button onclick="toggleSandbox()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex-1 flex flex-col md:flex-row gap-8 overflow-hidden">
                <div class="w-full md:w-1/3 space-y-6 overflow-y-auto p-2">
                    <div>
                        <label class="flex justify-between text-xs font-bold uppercase text-gray-500 mb-2"><span>Annual Salary</span> <span id="val-salary" class="text-blue-600">£50,000</span></label>
                        <input type="range" min="0" max="150000" step="1000" value="50000" oninput="updateSandbox()" id="range-salary">
                    </div>
                    <div>
                        <label class="flex justify-between text-xs font-bold uppercase text-gray-500 mb-2"><span>Dividends</span> <span id="val-dividend" class="text-purple-600">£0</span></label>
                        <input type="range" min="0" max="100000" step="1000" value="0" oninput="updateSandbox()" id="range-dividend">
                    </div>
                    <div>
                        <label class="flex justify-between text-xs font-bold uppercase text-gray-500 mb-2"><span>Business Expenses</span> <span id="val-expense" class="text-green-600">£0</span></label>
                        <input type="range" min="0" max="50000" step="500" value="0" oninput="updateSandbox()" id="range-expense">
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl text-xs text-blue-600 dark:text-blue-300">
                        Drag sliders to simulate your 2025/26 Tax Liability instantly.
                    </div>
                </div>
                <div class="w-full md:w-2/3 bg-gray-50 dark:bg-[#27272a] rounded-2xl p-4 flex items-center justify-center relative">
                    <canvas id="sandboxChart"></canvas>
                    <div class="absolute top-4 right-4 text-right">
                        <p class="text-xs text-gray-500 uppercase">Est. Take Home</p>
                        <p class="text-2xl font-bold text-green-500" id="val-takehome">£0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside id="sidebar" class="w-[260px] bg-[#f8fafc] dark:bg-[#101012] flex flex-col h-full hidden md:flex border-r border-gray-200 dark:border-gray-800 flex-shrink-0 pt-8">
        
        <div class="p-4 flex items-center justify-between mb-2">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-200 dark:hover:bg-[#27272a] rounded-lg text-gray-500 transition"><i class="fa-solid fa-bars text-lg"></i></button>
            <div onclick="goToHome()" class="flex-1 ml-3 font-bold text-lg tracking-tight cursor-pointer hover:opacity-70 transition select-none">TaxGPT</div>
            <button class="p-2 hover:bg-gray-200 dark:hover:bg-[#27272a] rounded-lg text-gray-500" onclick="startNewChat()"><i class="fa-regular fa-pen-to-square"></i></button>
        </div>

        <div class="px-4 space-y-2 mb-4">
            <button onclick="startNewChat()" class="w-full flex items-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-xl transition-all group shadow-md shadow-blue-200 dark:shadow-none">
                <i class="fa-solid fa-plus"></i>
                <span class="sidebar-text text-sm font-medium">New Chat</span>
            </button>
            <button onclick="toggleSandbox()" class="w-full flex items-center gap-3 bg-white dark:bg-[#27272a] border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-[#3f3f46] text-gray-700 dark:text-gray-200 py-2.5 px-4 rounded-xl transition-all group">
                <i class="fa-solid fa-gamepad text-purple-500"></i>
                <span class="sidebar-text text-sm font-medium">Tax Simulator</span>
            </button>
        </div>

        <div class="mx-4 mt-2 p-4 bg-white dark:bg-[#18181b] border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm sidebar-text">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase">Audit Risk</span>
                <i class="fa-solid fa-circle-info text-gray-300 text-xs"></i>
            </div>
            <div class="flex justify-center mb
