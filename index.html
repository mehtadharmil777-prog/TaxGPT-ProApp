<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxGPT Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { transition: background 0.3s, color 0.3s; }
        .dark body { background-color: #0d0d0d; color: #e5e5e5; }
        .ai-output h2 { font-size: 1.5rem; margin-top: 1rem; font-weight: 700; }
        #chatHistory::-webkit-scrollbar { width: 8px; }
        #chatHistory::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-black dark:text-white font-sans">

<button id="theme-toggle" class="fixed top-4 right-4 z-50 bg-gray-200 dark:bg-gray-700 p-3 rounded-full shadow cursor-pointer">üåô</button>

<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl text-lg font-semibold">Processing...</div>
</div>

<div class="flex h-screen overflow-hidden">
    <aside class="hidden md:flex flex-col w-72 bg-white dark:bg-gray-900 border-r dark:border-gray-800 p-6 shadow-lg z-20">
        <div class="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-8">TaxGPT Pro</div>
        <button onclick="window.location.reload()" class="bg-indigo-600 text-white py-3 px-4 rounded-xl mb-6 shadow-md">+ New Chat</button>
    </aside>

    <main class="flex-1 flex flex-col relative h-full">
        <div id="initial-view" class="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-8">
            <h2 class="text-3xl font-bold">How can I help you?</h2>
            <div class="flex flex-wrap justify-center gap-4">
                <button class="option bg-white dark:bg-gray-800 border p-6 rounded-2xl w-40 shadow-sm" onclick="setInput('I need quick tax advice regarding...')">‚ö° Quick Query</button>
                <button class="option bg-white dark:bg-gray-800 border p-6 rounded-2xl w-40 shadow-sm" onclick="setInput('Provide deep legal tax research on...')">üèõÔ∏è Deep Research</button>
            </div>
        </div>

        <div id="history" class="hidden flex-1 w-full p-8 overflow-y-auto space-y-6 pb-32"></div>

        <div class="p-6 bg-white dark:bg-black fixed bottom-0 w-full max-w-4xl left-0 right-0 mx-auto">
            <form id="form" class="flex items-center gap-2 bg-gray-100 dark:bg-gray-900 p-2 rounded-2xl border">
                <input type="file" id="file" accept="image/*" class="hidden">
                <label for="file" class="p-2 cursor-pointer text-gray-400 hover:text-indigo-600">üìé</label>
                <input id="input" class="flex-1 p-3 bg-transparent border-0 focus:ring-0 dark:text-white" placeholder="Ask anything about taxes...">
                <button type="submit" class="p-3 bg-indigo-600 text-white rounded-xl">‚û§</button>
            </form>
            <div id="file-preview" class="hidden text-xs text-indigo-600 mt-2">Image attached</div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC2yEjdOBRxrn4-GIM4Wyti9O6OvdnhhSg",
      authDomain: "taxgpt-f688d.firebaseapp.com",
      projectId: "taxgpt-f688d",
      storageBucket: "taxgpt-f688d.firebasestorage.app",
      messagingSenderId: "443595897158",
      appId: "1:443595897158:web:ff9ab1bdc19c915d4e0d47",
      measurementId: "G-QLS0ZZC8PV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId = null;
    let imageBase64 = null;

    signInAnonymously(auth).catch(e => console.error(e));

    onAuthStateChanged(auth, (u) => {
        if (u) {
            userId = u.uid;
            const q = query(collection(db, "artifacts", "default-app-id", "users", userId, "chats"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const history = snap.docs.map(d => d.data());
                renderHistory(history);
            });
        }
    });

    function renderHistory(history) {
        const historyBox = document.getElementById("history");
        const initialView = document.getElementById("initial-view");
        if (history.length > 0) {
            initialView.classList.add("hidden");
            historyBox.classList.remove("hidden");
        }
        historyBox.innerHTML = "";
        history.forEach(msg => {
            const div = document.createElement("div");
            div.className = `flex w-full ${msg.role === "model" ? "justify-start" : "justify-end"}`;
            div.innerHTML = `<div class="max-w-[75%] p-4 rounded-2xl shadow-sm ${msg.role === "model" ? "bg-white dark:bg-gray-800" : "bg-indigo-600 text-white"}">${msg.text}</div>`;
            historyBox.appendChild(div);
        });
        historyBox.scrollTop = historyBox.scrollHeight;
    }

    window.setInput = (text) => {
        document.getElementById("input").value = text;
        document.getElementById("input").focus();
    }

    document.getElementById("file").onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageBase64 = e.target.result.split(",")[1];
                document.getElementById("file-preview").classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }
    };

    document.getElementById("form").onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById("input").value;
        if (!text && !imageBase64) return;
        if (!userId) return alert("Connecting... please wait.");

        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("input").value = "";
        document.getElementById("file-preview").classList.add("hidden");

        // Save User Message
        await addDoc(collection(db, "artifacts", "default-app-id", "users", userId, "chats"), { role: "user", text, timestamp: Date.now() });

        // Call Vercel Proxy
        try {
            const res = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: text, image: imageBase64 })
            });
            const data = await res.json();
            await addDoc(collection(db, "artifacts", "default-app-id", "users", userId, "chats"), { role: "model", text: data.response || "Error: No response", timestamp: Date.now() });
        } catch (err) {
            console.error(err);
            await addDoc(collection(db, "artifacts", "default-app-id", "users", userId, "chats"), { role: "model", text: "Error connecting to AI.", timestamp: Date.now() });
        }
        
        imageBase64 = null;
        document.getElementById("loading").classList.add("hidden");
    };

    document.getElementById("theme-toggle").onclick = () => document.documentElement.classList.toggle("dark");
</script>
</body>
</html>
