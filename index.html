<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxLLM | Professional Tax Intelligence</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { appleGray: '#F5F5F7', appleDark: '#1D1D1F', appleBlue: '#0066CC' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'pulse-slow': 'pulse 2s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* Markdown Styling */
        .prose h3 { font-weight: 600; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; color: #111; }
        .prose ul { list-style-type: disc; padding-left: 1.4em; margin-bottom: 1em; color: #374151; }
        .prose strong { color: #000; font-weight: 600; }
        .prose a { color: #0066CC; text-decoration: none; font-weight: 500; }
        .prose a:hover { text-decoration: underline; }

        /* Loading Dots */
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite alternate; }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #888; } 50%, 100% { background-color: #ccc; } }
        
        .mic-listening { color: #ef4444 !important; animation: pulse-slow 1.5s infinite; }
    </style>
</head>
<body class="bg-white text-appleDark">

    <div id="modal-library" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-4xl m-4 animate-fade-in max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Official Tax Library</h3>
                <button onclick="closeModals(null, true)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="https://www.gov.uk/government/organisations/hm-revenue-customs" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡¬ðŸ‡§ UK</div><div class="text-xs text-gray-500">HMRC</div></a>
                <a href="https://www.irs.gov/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡ºðŸ‡¸ USA</div><div class="text-xs text-gray-500">IRS</div></a>
                <a href="https://tax.gov.ae/en" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡¦ðŸ‡ª UAE</div><div class="text-xs text-gray-500">FTA</div></a>
                <a href="https://incometaxindia.gov.in/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡®ðŸ‡³ India</div><div class="text-xs text-gray-500">ITD</div></a>
                <a href="https://www.canada.ca/en/revenue-agency.html" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡¨ðŸ‡¦ Canada</div><div class="text-xs text-gray-500">CRA</div></a>
                <a href="https://www.ato.gov.au/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡¦ðŸ‡º Australia</div><div class="text-xs text-gray-500">ATO</div></a>
                <a href="https://www.bzst.bund.de/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group"><div class="font-bold group-hover:text-blue-600">ðŸ‡©ðŸ‡ª Germany</div><div class="text-xs text-gray-500">BZSt</div></a>
                <a href="https://www.impots.gouv.fr/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition text-center"><div class="font-bold group-hover:text-blue-600">ðŸ‡«ðŸ‡· France</div><div class="text-xs text-gray-500">DGFiP</div></a>
            </div>
        </div>
    </div>

    <div id="modal-info" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg m-4 animate-fade-in relative">
            <button onclick="closeModals(null, true)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Title</h3>
            <div id="modal-content" class="prose text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="modal-disclaimer" class="fixed inset-0 z-[150] flex items-center justify-center bg-black/70 backdrop-blur-md hidden px-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-gavel"></i></div>
            <h2 class="text-xl font-bold mb-2">Legal Disclaimer</h2>
            <div class="text-left bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-gray-600 mb-4 h-32 overflow-y-auto">
                <p class="mb-2"><strong>1. NO PROFESSIONAL ADVICE:</strong> TaxLLM is an AI-powered informational tool. It is NOT a substitute for professional legal or tax advice. No accountant-client relationship is formed.</p>
                <p class="mb-2"><strong>2. ACCURACY:</strong> While we strive for accuracy, automated systems may produce errors. You assume full responsibility for verifying all information with official sources.</p>
                <p class="mb-2"><strong>3. LIMITATION OF LIABILITY:</strong> TO THE FULLEST EXTENT PERMITTED BY LAW, TAXLLM AND ITS FOUNDERS SHALL NOT BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL DAMAGES RESULTING FROM THE USE OF THIS TOOL.</p>
            </div>
            <label class="flex items-center gap-2 text-sm text-gray-600 mb-4 cursor-pointer">
                <input type="checkbox" id="agree-check" class="rounded text-blue-600" onchange="toggleEnterBtn()">
                I have read and agree to the Terms & Conditions.
            </label>
            <button id="btn-enter" onclick="acceptDisclaimer()" class="w-full bg-black text-white py-3 rounded-xl font-bold opacity-50 cursor-not-allowed" disabled>Enter Workspace</button>
        </div>
    </div>

    <div id="landing-view">
        <nav class="fixed w-full z-50 glass-nav transition-all duration-300">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 font-bold text-xl tracking-tight text-gray-900 cursor-pointer" onclick="location.reload()">
                    <i class="fa-solid fa-scale-balanced text-black"></i> TaxLLM
                </div>
                <div class="hidden md:flex space-x-8 text-sm font-medium text-gray-600">
                    <button onclick="scrollToSection('features')" class="hover:text-black transition">Features</button>
                    <button onclick="scrollToSection('pricing')" class="hover:text-black transition">Pricing</button>
                    <button onclick="openModal('library')" class="hover:text-black transition">Library</button>
                    <button onclick="openContentModal('about')" class="hover:text-black transition">About</button>
                </div>
                <div class="flex gap-3 text-sm">
                    <button onclick="switchView('app')" class="bg-black text-white px-5 py-2 rounded-full font-medium hover:bg-gray-800 transition transform hover:scale-105">Launch App</button>
                </div>
            </div>
        </nav>

        <section class="pt-40 pb-20 px-6 text-center max-w-5xl mx-auto animate-fade-in">
            <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 leading-tight text-gray-900">Your AI Tax Expert.</h1>
            <p class="text-xl md:text-2xl text-gray-500 font-light mb-10 max-w-3xl mx-auto">Accurate. Cited. Country-specific. Trusted by professionals.</p>
            <div class="relative max-w-2xl mx-auto mb-20 group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><i class="fa-solid fa-magnifying-glass text-gray-400 text-lg"></i></div>
                <input type="text" id="landing-search" class="w-full pl-14 pr-14 py-5 rounded-full border border-gray-200 shadow-lg text-lg focus:outline-none focus:ring-4 focus:ring-gray-100 transition" placeholder="Ask anything about tax..." onkeydown="if(event.key === 'Enter') handleLandingSearch()">
                <button onclick="handleLandingSearch()" class="absolute right-2 top-2 bg-black text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-800 transition shadow-md"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </section>

        <section id="features" class="bg-white py-20 px-6 border-t border-gray-100">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16"><h2 class="text-3xl font-bold">Everything You Need for Tax</h2><p class="text-gray-500 mt-2">Powerful tools integrated into one workspace.</p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-magnifying-glass text-gray-600 text-xl"></i> <span class="font-medium">Tax Search</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-globe text-gray-600 text-xl"></i> <span class="font-medium">Country Summaries</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-envelope-open-text text-gray-600 text-xl"></i> <span class="font-medium">Email Generator</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-file-pdf text-gray-600 text-xl"></i> <span class="font-medium">Document Helper</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-gavel text-gray-600 text-xl"></i> <span class="font-medium">Case Law Explorer</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4 cursor-default"><i class="fa-solid fa-scale-balanced text-gray-600 text-xl"></i> <span class="font-medium">Comparisons</span></div>
                </div>
            </div>
        </section>
        
        <section id="pricing" class="py-24 px-6 max-w-6xl mx-auto bg-appleGray">
             <div class="text-center mb-12"><h2 class="text-3xl font-bold">Simple Pricing</h2></div>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                 <div class="bg-white p-8 rounded-3xl border border-gray-200"><h3 class="font-bold text-xl">Free</h3><p class="text-3xl font-bold my-4">$0</p><button onclick="switchView('app')" class="w-full border py-2 rounded-lg hover:bg-gray-50">Get Started</button></div>
                 <div class="bg-black text-white p-8 rounded-3xl shadow-xl transform scale-105"><h3 class="font-bold text-xl">Pro</h3><p class="text-3xl font-bold my-4">$29</p><button onclick="switchView('app')" class="w-full bg-white text-black py-2 rounded-lg hover:bg-gray-100">Start Trial</button></div>
                 <div class="bg-white p-8 rounded-3xl border border-gray-200"><h3 class="font-bold text-xl">Enterprise</h3><p class="text-3xl font-bold my-4">Custom</p><button class="w-full border py-2 rounded-lg hover:bg-gray-50">Contact Sales</button></div>
             </div>
        </section>

        <footer class="py-12 border-t border-gray-100 text-center text-sm text-gray-500 bg-white">
            <div class="flex justify-center gap-8 mb-6">
                <button onclick="openContentModal('about')" class="hover:text-black">About</button>
                <button onclick="openContentModal('security')" class="hover:text-black">Security</button>
                <button onclick="openContentModal('terms')" class="hover:text-black">Terms</button>
                <button onclick="openContentModal('contact')" class="hover:text-black">Contact</button>
            </div>
            <div class="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-50 border border-gray-200 text-xs font-medium text-gray-600"><span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span><span id="live-counter">1,242</span> Visits</div>
            <p>&copy; 2025 TaxLLM. Built by Dharmil Mehta.</p>
        </footer>
    </div>

    <div id="app-view" class="hidden h-screen flex bg-white font-sans text-gray-900">
        <aside class="w-[260px] bg-[#202123] text-gray-200 flex flex-col h-full border-r border-gray-800 flex-shrink-0">
            <div class="p-3">
                <button onclick="resetChat()" class="w-full border border-gray-600 hover:bg-[#2A2B32] text-white rounded-md py-3 px-3 flex items-center gap-3 text-sm transition text-left"><i class="fa-solid fa-plus"></i> New Chat</button>
            </div>
            <div class="flex-1 overflow-y-auto px-3 py-2 space-y-1 custom-scroll">
                <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider px-2 mt-4 mb-1">Tools</div>
                <button onclick="openTool('summaries')" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left"><i class="fa-solid fa-globe w-4"></i> Tax Summaries</button>
                <button onclick="openTool('email')" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left"><i class="fa-solid fa-envelope-open-text w-4"></i> Correspondence</button>
                <button onclick="openTool('salary')" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left"><i class="fa-solid fa-calculator w-4"></i> Salary Calculator</button>
                <button onclick="triggerUpload()" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left"><i class="fa-solid fa-file-pdf w-4"></i> Document Helper</button>
                
                <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider px-2 mt-6 mb-1">History</div>
                <div id="history-list" class="space-y-1"></div>
            </div>
            <div class="p-3 border-t border-gray-700">
                <button onclick="openModal('library')" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left mb-1"><i class="fa-solid fa-book-atlas w-4"></i> Official Library</button>
                <button onclick="switchView('landing')" class="w-full flex items-center gap-3 px-3 py-3 rounded hover:bg-[#2A2B32] text-sm transition text-left"><i class="fa-solid fa-right-from-bracket w-4"></i> Exit App</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-white">
            <header class="h-14 border-b border-gray-100 flex items-center justify-between px-6 bg-white/95 backdrop-blur z-10">
                <div class="font-semibold text-gray-700 cursor-pointer" onclick="resetChat()">TaxLLM <span class="bg-gray-100 text-gray-500 text-[10px] px-1.5 py-0.5 rounded ml-2">PRO</span></div>
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="toggleMode()">
                        <span class="text-gray-400 text-xs">Simple</span><i class="fa-solid fa-toggle-on text-black text-xl" id="mode-icon"></i><span class="font-medium text-xs">Expert</span>
                    </div>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-6 pb-40 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto animate-fade-in">
                    <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center text-3xl mb-6 text-gray-400"><i class="fa-solid fa-scale-balanced"></i></div>
                    <h2 class="text-2xl font-semibold mb-2 text-gray-800">How can I help with your taxes?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full mt-8">
                        <button onclick="openTool('salary')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition">
                            <div class="font-bold text-sm mb-1 text-gray-800">Salary Calc</div>
                            <div class="text-xs text-gray-400">Net pay estimator</div>
                        </button>
                        <button onclick="openTool('email')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition">
                            <div class="font-bold text-sm mb-1 text-gray-800">Email Gen</div>
                            <div class="text-xs text-gray-400">Draft letters</div>
                        </button>
                        <button onclick="sendPreset('I need to visualize data. Ask me for the figures.')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition">
                            <div class="font-bold text-sm mb-1 text-gray-800">Visualizer</div>
                            <div class="text-xs text-gray-400">Create charts</div>
                        </button>
                    </div>
                </div>
                
                <div id="tool-view" class="hidden max-w-xl mx-auto mt-4 bg-white p-8 rounded-3xl border border-gray-200 shadow-lg"></div>

                <div id="chat-output" class="max-w-3xl mx-auto space-y-8 hidden pt-4"></div>
                <div id="loading" class="hidden max-w-3xl mx-auto pt-4 flex gap-4 items-center"><div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500"><i class="fa-solid fa-bolt text-xs"></i></div><div class="text-sm text-gray-500 font-medium">Thinking...</div></div>
            </div>

            <div class="absolute bottom-0 w-full bg-white pt-4 pb-8 px-6 border-t border-gray-100">
                <div class="max-w-3xl mx-auto relative">
                    <div class="relative shadow-card rounded-xl border border-gray-300 bg-white focus-within:border-gray-500 focus-within:ring-1 focus-within:ring-gray-500 transition">
                        <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" onchange="handleFileUpload(this)">
                        <div class="flex items-center p-2">
                            <button onclick="triggerUpload()" class="p-2 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-paperclip"></i></button>
                            <button onclick="toggleVoice()" class="p-2 text-gray-400 hover:text-gray-600"><i id="mic-icon" class="fa-solid fa-microphone"></i></button>
                            <textarea id="user-input" rows="1" class="w-full p-2 resize-none focus:outline-none text-sm max-h-40" placeholder="Ask TaxLLM..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                            <button id="stop-btn" onclick="stopGeneration()" class="hidden p-2 text-gray-600 hover:text-red-500"><i class="fa-solid fa-stop"></i></button>
                            <button id="send-btn" onclick="sendMessage()" class="p-2 text-white bg-black rounded-lg hover:bg-gray-800 ml-2"><i class="fa-solid fa-arrow-up"></i></button>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-[10px] text-gray-400">Answers are verified by official sources. Check important info.</div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed top-14 left-1/2 transform -translate-x-1/2 z-[150] flex flex-col gap-2 pointer-events-none"></div>

    <script>
        let state = { mode: 'Expert', controller: null, history: [] };

        // --- CONTENT MODALS ---
        const contentData = {
            'about': { title: 'About TaxLLM', body: 'Built by <strong>Dharmil Mehta</strong>, Founder of TaxLLM. Our mission is to bridge the gap between complex tax legislation and modern AI. TaxLLM provides accurate, cited, and instant tax answers for professionals.' },
            'security': { title: 'Data Security', body: 'We utilize industry-standard encryption (TLS 1.3) for all data in transit. We do not store sensitive personally identifiable information (PII) or financial records on our servers. All AI interactions are stateless and anonymized.' },
            'terms': { title: 'Terms of Service', body: 'Disclaimer: TaxLLM provides information, not legal advice. Always verify outputs with a qualified accountant or tax advisor. By using this tool, you agree to our terms of service. Limitation of Liability applies.' },
            'contact': { title: 'Contact Us', body: 'For general inquiries, partnerships, or support, please reach out.<br><br><strong>Email:</strong> dharmil@taxllm.pro<br><strong>Response Time:</strong> Within 24 hours.' }
        };

        // --- UI FUNCTIONS ---
        function openContentModal(type) {
            document.getElementById('modal-title').innerHTML = contentData[type].title;
            document.getElementById('modal-content').innerHTML = contentData[type].body;
            document.getElementById('modal-info').classList.remove('hidden');
        }
        function openModal(id) { document.getElementById('modal-' + id).classList.remove('hidden'); }
        function closeModals(e, force) { if(force || e.target.id.startsWith('modal-')) document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden')); }
        function toggleEnterBtn() { const b = document.getElementById('btn-enter'); b.disabled = !document.getElementById('agree-check').checked; b.classList.toggle('opacity-50'); b.classList.toggle('cursor-not-allowed'); }
        function acceptDisclaimer() { localStorage.setItem('taxgpt_accepted', 'true'); document.getElementById('modal-disclaimer').classList.add('hidden'); }
        function switchView(view) { 
            document.getElementById('landing-view').classList.toggle('hidden', view === 'app'); 
            document.getElementById('app-view').classList.toggle('hidden', view !== 'app');
            if(view === 'app') scrollToSection('app-view'); // Ensure top of app
        }
        function handleLandingSearch() { const q = document.getElementById('landing-search').value; if(q.trim()) { switchView('app'); document.getElementById('user-input').value = q; sendMessage(); } }
        function resetChat() { 
            document.getElementById('welcome-screen').classList.remove('hidden'); 
            document.getElementById('chat-output').classList.add('hidden'); 
            document.getElementById('chat-output').innerHTML = ''; 
            document.getElementById('tool-view').classList.add('hidden'); 
        }
        function toggleMode() { state.mode = state.mode === 'Expert' ? 'Simple' : 'Expert'; document.getElementById('mode-icon').className = state.mode === 'Expert' ? 'fa-solid fa-toggle-on text-black text-xl' : 'fa-solid fa-toggle-off text-gray-400 text-xl'; }
        function stopGeneration() { if(state.controller) { state.controller.abort(); state.controller = null; document.getElementById('loading').classList.add('hidden'); document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden'); } }
        function sendPreset(t) { document.getElementById('user-input').value = t; sendMessage(); }
        function scrollToSection(id) { 
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({behavior: 'smooth'}); 
        }
        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm animate-fade-in";
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        // --- TOOL FUNCTIONS ---
        function openTool(type) {
            document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.add('hidden');
            const view = document.getElementById('tool-view'); view.classList.remove('hidden');
            
            if(type === 'salary') {
                view.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Salary Calculator</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div><div class="space-y-4"><input type="number" id="calc-amount" class="w-full p-3 border rounded-lg" placeholder="Gross Annual Income"><button onclick="document.getElementById('calc-res').innerHTML='Net: '+(document.getElementById('calc-amount').value*0.8).toFixed(0)" class="w-full bg-black text-white py-2 rounded-lg">Calculate</button><div id="calc-res" class="text-center font-bold text-xl mt-4"></div></div>`;
            } else if(type === 'email') {
                view.innerHTML = `
                    <div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Letter Generator</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="space-y-4">
                        <input type="text" id="email-to" class="w-full p-3 border rounded-lg" placeholder="Recipient (e.g. HMRC)">
                        <input type="text" id="email-purpose" class="w-full p-3 border rounded-lg" placeholder="Purpose (e.g. Appeal)">
                        <select id="email-tone" class="w-full p-3 border rounded-lg"><option>Formal</option><option>Urgent</option></select>
                        <button onclick="sendPreset('Draft a ' + document.getElementById('email-tone').value + ' letter to ' + document.getElementById('email-to').value + ' regarding ' + document.getElementById('email-purpose').value)" class="w-full bg-black text-white py-2 rounded-lg">Generate</button>
                    </div>`;
            } else if(type === 'summaries') {
                 view.innerHTML = `
                    <div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Deep Tax Summaries</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="space-y-4">
                        <select id="sum-country" class="w-full p-3 border rounded-lg"><option>UK</option><option>USA</option><option>UAE</option><option>India</option></select>
                        <select id="sum-cat" class="w-full p-3 border rounded-lg"><option>Corporate Tax</option><option>VAT/GST</option><option>Withholding Tax</option><option>Transfer Pricing</option><option>R&D Credits</option><option>Employment Tax</option></select>
                        <button onclick="sendPreset('Provide a detailed tax summary for ' + document.getElementById('sum-country').value + ' regarding ' + document.getElementById('sum-cat').value + '. Use a table.')" class="w-full bg-black text-white py-2 rounded-lg">Fetch Data</button>
                    </div>`;
            }
        }

        function triggerUpload() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { 
             if (input.files && input.files[0]) {
                switchView('app'); document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.remove('hidden');
                document.getElementById('chat-output').insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-gray-100 text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">ðŸ“„ File: ${input.files[0].name}</div></div>`);
                document.getElementById('loading').classList.remove('hidden');
                Tesseract.recognize(input.files[0], 'eng').then(({ data: { text } }) => {
                     document.getElementById('loading').classList.add('hidden');
                     document.getElementById('user-input').value = `Analyze this document text: "${text.substring(0, 500)}..."`;
                     sendMessage();
                });
             }
        }
        
        // Voice Dictation
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) { alert("Voice not supported"); return; }
            const btn = document.getElementById('mic-icon');
            const recognition = new webkitSpeechRecognition();
            recognition.onstart = () => { btn.classList.add('mic-listening'); };
            recognition.onend = () => { btn.classList.remove('mic-listening'); };
            recognition.onresult = (event) => { document.getElementById('user-input').value = event.results[0][0].transcript; };
            recognition.start();
        }

        // --- CHAT LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('user-input'); const text = input.value.trim(); if(!text) return;
            
            state.controller = new AbortController();
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('tool-view').classList.add('hidden');
            const output = document.getElementById('chat-output'); output.classList.remove('hidden');
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');

            output.insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-gray-100 text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">${text}</div></div>`);
            input.value = ''; window.scrollTo(0, document.body.scrollHeight);
            document.getElementById('loading').classList.remove('hidden');

            try {
                // UPDATED SYSTEM PROMPT TO FORCE APPLE-STYLE FORMATTING
                const promptText = `You are TaxLLM. 
                FORMAT RULES:
                1. Use this EXACT structure:
                ### Key Facts
                (Bullet points)
                ### Scope & Thresholds
                (Details)
                ### Practical Implications
                (Advice)
                ### Sources
                [Source 1] [Source 2] (Use bracket notation like [HMRC])

                MODE: ${state.mode}.
                User Query: ${text}`;

                const res = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: promptText }),
                    signal: state.controller.signal
                });
                const data = await res.json();
                document.getElementById('loading').classList.add('hidden');
                
                const msgId = Date.now();
                // Parse [Source] into Citation Badges
                let formattedResp = marked.parse(data.response);
                formattedResp = formattedResp.replace(/\[(.*?)\]/g, '<span class="citation-badge">$1</span>');

                output.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-4 group fade-in">
                        <div class="w-8 h-8 bg-gray-900 text-white rounded-lg flex items-center justify-center flex-shrink-0 text-xs font-bold">AI</div>
                        <div class="flex-1 max-w-3xl">
                            <div class="prose prose-sm text-gray-800 leading-7 mb-3" id="content-${msgId}">${formattedResp}</div>
                            <div class="flex gap-2 items-center opacity-0 group-hover:opacity-100 transition">
                                <button onclick="navigator.clipboard.writeText(document.getElementById('content-${msgId}').innerText);showToast('Copied')" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Copy</button>
                                <button onclick="document.getElementById('user-input').value='Simplify this';sendMessage()" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Simplify</button>
                                <button onclick="document.getElementById('user-input').value='Key Takeaways';sendMessage()" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Key Takeaways</button>
                                <div class="flex gap-1 ml-2 border-l pl-2">
                                    <button class="p-1.5 text-gray-400 hover:text-green-500" onclick="showToast('Thanks for feedback')"><i class="fa-regular fa-thumbs-up"></i></button>
                                    <button class="p-1.5 text-gray-400 hover:text-red-500" onclick="showToast('Thanks for feedback')"><i class="fa-regular fa-thumbs-down"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`);
                
                if(state.history[0] !== text) {
                    state.history.unshift(text);
                    const histList = document.getElementById('history-list');
                    const btn = document.createElement('button');
                    btn.className = "w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-sm transition text-left text-gray-400 truncate";
                    btn.innerHTML = `<i class="fa-regular fa-message w-4"></i> ${text}`;
                    btn.onclick = () => { document.getElementById('user-input').value = text; sendMessage(); };
                    histList.prepend(btn);
                }

            } catch(err) { if(err.name !== 'AbortError') document.getElementById('loading').classList.add('hidden'); }
            finally { document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden'); state.controller = null; }
            window.scrollTo(0, document.body.scrollHeight);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(!localStorage.getItem('taxgpt_accepted')) document.getElementById('modal-disclaimer').classList.remove('hidden');
            
            let visits = parseInt(localStorage.getItem('taxgpt_visits') || 1240);
            visits++;
            localStorage.setItem('taxgpt_visits', visits);
            document.getElementById('live-counter').innerText = visits.toLocaleString();
        });
    </script>
</body>
</html>
