<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaxGPT Pro</title>

  <!-- Tailwind CDN (OK for now) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex h-screen">

    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg p-6 flex flex-col">
      <h1 class="text-2xl font-bold mb-6 text-indigo-600">TaxGPT Pro</h1>

      <button id="newChatBtn" class="w-full bg-indigo-600 text-white py-2 rounded mb-4">
        New Chat
      </button>

      <h2 class="text-gray-500 font-semibold mb-2">Projects</h2>
      <ul id="projectList" class="space-y-2"></ul>

      <div class="mt-auto text-xs text-gray-400">
        User ID: <span id="userIdLabel"></span>
      </div>
    </div>

    <!-- Main Chat Window -->
    <div class="flex-1 flex flex-col p-6">
      <div id="chatContainer" class="flex-1 overflow-y-auto p-4 bg-white shadow rounded"></div>

      <!-- Chat Input -->
      <div class="mt-4 flex items-center space-x-2">
        <input id="chatInput" 
               type="text"
               placeholder="Ask anything..."
               class="flex-1 border rounded px-4 py-2" />
        <button id="sendBtn" class="bg-indigo-600 text-white rounded-full px-6 py-2">
          â†’
        </button>
      </div>
    </div>

  </div>

<script>
/* ---------------------------------------------------
    FIREBASE CONFIG
---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------------------------------------------
    AUTO LOGIN (ANONYMOUS)
---------------------------------------------------- */
auth.signInAnonymously()
  .then(() => {
    console.log("âœ… Firebase Auth: Signed in anonymously");

    document.getElementById("userIdLabel").innerText =
      auth.currentUser.uid;

    loadProjects();
  })
  .catch((err) => console.error("Auth error:", err));

/* ---------------------------------------------------
    LOAD USER'S PROJECTS
---------------------------------------------------- */
async function loadProjects() {
  const uid = auth.currentUser.uid;

  const snapshot = await db
    .collection("users")
    .doc(uid)
    .collection("consultations")
    .get();

  const list = document.getElementById("projectList");
  list.innerHTML = "";

  snapshot.forEach((doc) => {
    const li = document.createElement("li");
    li.className = "cursor-pointer text-indigo-500 hover:underline";
    li.innerText = doc.id;
    li.onclick = () => loadChat(doc.id);
    list.appendChild(li);
  });
}

/* ---------------------------------------------------
    LOAD CHAT HISTORY
---------------------------------------------------- */
async function loadChat(chatId) {
  const uid = auth.currentUser.uid;

  const ref = db
    .collection("users")
    .doc(uid)
    .collection("consultations")
    .doc(chatId)
    .collection("messages");

  const snapshot = await ref.orderBy("timestamp").get();

  const container = document.getElementById("chatContainer");
  container.innerHTML = "";

  snapshot.forEach((msg) => {
    addMessageToUI(msg.data().role, msg.data().content);
  });
}

/* ---------------------------------------------------
    ADD MESSAGE TO UI
---------------------------------------------------- */
function addMessageToUI(role, text) {
  const container = document.getElementById("chatContainer");

  const bubble = document.createElement("div");
  bubble.className =
    role === "user"
      ? "text-right mb-2"
      : "text-left mb-2";

  bubble.innerHTML = `
    <div class="inline-block px-4 py-2 rounded-lg ${
      role === "user"
        ? "bg-indigo-600 text-white"
        : "bg-gray-200 text-gray-800"
    }">
      ${text}
    </div>
  `;

  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
}

/* ---------------------------------------------------
    GEMINI API CALL
---------------------------------------------------- */
async function callGeminiAPI(message) {
  console.log("ðŸ“¨ Sending to Gemini:", message);

  const API_KEY = "YOUR_API_KEY_HERE";
  const MODEL = "gemini-1.5-flash"; // ðŸ”¥ stable, fast, working

  const url = `https://generativelanguage.googleapis.com/v1/models/${MODEL}:generateContent?key=${API_KEY}`;

  const body = {
    contents: [
      { role: "user", parts: [{ text: message }] }
    ]
  };

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    console.log("ðŸ” GEMINI RAW RESPONSE:", data);

    if (!data.candidates) {
      console.error("âŒ Gemini returned no candidates:", data);
      return "âš ï¸ AI Error: Check console.";
    }

    return data.candidates[0].content.parts[0].text;

  } catch (err) {
    console.error("âŒ Network/Gemini error:", err);
    return "âš ï¸ Network Error: See console.";
  }
}

/* ---------------------------------------------------
    SAVE MESSAGE TO FIRESTORE
---------------------------------------------------- */
async function saveMessage(chatId, role, content) {
  const uid = auth.currentUser.uid;

  const ref = db
    .collection("users")
    .doc(uid)
    .collection("consultations")
    .doc(chatId)
    .collection("messages");

  await ref.add({
    role,
    content,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

/* ---------------------------------------------------
    NEW CHAT BUTTON
---------------------------------------------------- */
document.getElementById("newChatBtn").onclick = async () => {
  const uid = auth.currentUser.uid;

  const newDoc = await db
    .collection("users")
    .doc(uid)
    .collection("consultations")
    .doc();

  await newDoc.set({ createdAt: Date.now() });

  loadProjects();
};

/* ---------------------------------------------------
    SEND MESSAGE
---------------------------------------------------- */
document.getElementById("sendBtn").onclick = async () => {
  const text = document.getElementById("chatInput").value.trim();
  if (!text) return;

  const uid = auth.currentUser.uid;
  const chatId = "default-session"; // simple single thread for now

  addMessageToUI("user", text);
  await saveMessage(chatId, "user", text);

  document.getElementById("chatInput").value = "";

  const reply = await callGeminiAPI(text);

  addMessageToUI("assistant", reply);
  await saveMessage(chatId, "assistant", reply);
};
</script>

</body>
</html>
