<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaxLLM | Professional Tax Intelligence</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { appleGray: '#F5F5F7', appleDark: '#1D1D1F', appleBlue: '#0066CC' },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* Markdown */
        .prose h3 { font-weight: 600; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; color: #111; }
        .prose ul { list-style-type: disc; padding-left: 1.4em; margin-bottom: 1em; color: #374151; }
        .prose strong { color: #000; font-weight: 600; }
        .prose a { color: #0066CC; text-decoration: none; font-weight: 500; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; }
        .prose th { background: #f9fafb; padding: 8px; border: 1px solid #e5e7eb; text-align: left; }
        .prose td { padding: 8px; border: 1px solid #e5e7eb; }

        /* Loading */
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite alternate; }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #888; } 50%, 100% { background-color: #ccc; } }
    </style>
</head>
<body class="bg-white text-appleDark">

    <div id="modal-library" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-4xl m-4 animate-fade-in max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Official Tax Library</h3><button onclick="closeModals(null, true)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="https://www.gov.uk/government/organisations/hm-revenue-customs" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡¬ðŸ‡§ UK</div><div class="text-xs text-gray-500">HMRC</div></a>
                <a href="https://www.irs.gov/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡ºðŸ‡¸ USA</div><div class="text-xs text-gray-500">IRS</div></a>
                <a href="https://tax.gov.ae/en" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡¦ðŸ‡ª UAE</div><div class="text-xs text-gray-500">FTA</div></a>
                <a href="https://incometaxindia.gov.in/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡®ðŸ‡³ India</div><div class="text-xs text-gray-500">ITD</div></a>
                <a href="https://www.canada.ca/en/revenue-agency.html" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡¨ðŸ‡¦ Canada</div><div class="text-xs text-gray-500">CRA</div></a>
                <a href="https://www.ato.gov.au/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 transition"><div class="font-bold">ðŸ‡¦ðŸ‡º Australia</div><div class="text-xs text-gray-500">ATO</div></a>
            </div>
        </div>
    </div>

    <div id="modal-info" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg m-4 animate-fade-in relative">
            <button onclick="closeModals(null, true)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Title</h3>
            <div id="modal-content" class="prose text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="landing-view">
        <nav class="fixed w-full z-50 glass-nav transition-all duration-300">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 font-bold text-xl tracking-tight text-gray-900 cursor-pointer" onclick="location.reload()"><i class="fa-solid fa-scale-balanced text-black"></i> TaxLLM</div>
                <div class="hidden md:flex space-x-8 text-sm font-medium text-gray-600">
                    <button onclick="document.getElementById('features').scrollIntoView({behavior: 'smooth'})" class="hover:text-black">Features</button>
                    <button onclick="document.getElementById('faq').scrollIntoView({behavior: 'smooth'})" class="hover:text-black">FAQ</button>
                    <button onclick="openModal('library')" class="hover:text-black">Library</button>
                    <button onclick="openContentModal('about')" class="hover:text-black">About</button>
                </div>
                <div class="flex gap-3 text-sm"><button onclick="switchView('app')" class="bg-black text-white px-5 py-2 rounded-full font-medium hover:bg-gray-800 transition transform hover:scale-105">Launch App</button></div>
            </div>
        </nav>

        <section class="pt-32 pb-20 px-6 text-center max-w-5xl mx-auto animate-fade-in">
            <h1 class="text-5xl md:text-6xl font-bold tracking-tight mb-6 leading-tight text-gray-900">Your AI Tax Expert.</h1>
            <p class="text-lg text-gray-500 font-light mb-10 max-w-2xl mx-auto">Accurate. Cited. Country-specific. Trusted by professionals.</p>
            <div class="relative max-w-2xl mx-auto mb-20 group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><i class="fa-solid fa-magnifying-glass text-gray-400 text-lg"></i></div>
                <input type="text" id="landing-search" class="w-full pl-14 pr-14 py-4 rounded-full border border-gray-200 shadow-lg text-lg focus:outline-none focus:ring-4 focus:ring-gray-100 transition" placeholder="Ask anything about tax..." onkeydown="if(event.key === 'Enter') handleLandingSearch()">
                <button onclick="handleLandingSearch()" class="absolute right-2 top-2 bg-black text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-800 transition shadow-md"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </section>

        <section id="features" class="bg-white py-20 px-6 border-t border-gray-100">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-12"><h2 class="text-3xl font-bold">Everything You Need for Tax</h2></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-magnifying-glass text-gray-600 text-xl"></i> <span class="font-medium">Tax Search</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-globe text-gray-600 text-xl"></i> <span class="font-medium">Country Summaries</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-envelope-open-text text-gray-600 text-xl"></i> <span class="font-medium">Email Generator</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-file-pdf text-gray-600 text-xl"></i> <span class="font-medium">Document Helper</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-list-check text-gray-600 text-xl"></i> <span class="font-medium">Reminders & Notes</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-calculator text-gray-600 text-xl"></i> <span class="font-medium">Calculators</span></div>
                </div>
            </div>
        </section>

        <section id="faq" class="py-20 px-6 bg-appleGray">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-12">Frequently Asked Questions</h2>
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-2xl border border-gray-200">
                        <h3 class="font-bold text-sm mb-2">What is TaxLLM?</h3>
                        <p class="text-sm text-gray-600 leading-relaxed">TaxLLM is a specialized AI workspace designed for accountants and tax professionals. Unlike generic chatbots, it is grounded in official tax documentation for major economies. It combines AI reasoning with practical tools like calculators, email drafting, and document analysis.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-gray-200">
                        <h3 class="font-bold text-sm mb-2">Why is this different from Gemini or ChatGPT?</h3>
                        <p class="text-sm text-gray-600 leading-relaxed">Generic models often hallucinate tax rates. TaxLLM uses hard-coded 2025 thresholds and forces citations. We do not use your data to train models. Plus, we offer built-in tools like Salary Calculators and Reminders that standard chatbots lack.</p>
                        <button onclick="switchView('app')" class="mt-3 text-blue-600 text-xs font-bold uppercase hover:underline">Try it yourself <i class="fa-solid fa-arrow-right ml-1"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="py-12 border-t border-gray-100 text-center text-sm text-gray-500 bg-white">
            <div class="flex justify-center gap-8 mb-6">
                <button onclick="openContentModal('about')" class="hover:text-black">About</button>
                <button onclick="openContentModal('security')" class="hover:text-black">Security</button>
                <button onclick="openContentModal('terms')" class="hover:text-black">Terms</button>
                <button onclick="openContentModal('contact')" class="hover:text-black">Contact</button>
            </div>
            <p>&copy; 2025 TaxLLM. v2.0</p>
        </footer>
    </div>

    <div id="app-view" class="hidden h-screen flex bg-white font-sans text-gray-900">
        <aside class="w-[260px] bg-[#fbfbfd] flex flex-col h-full border-r border-gray-200 flex-shrink-0">
            <div class="p-3">
                <button onclick="resetChat()" class="w-full border border-gray-200 hover:border-gray-300 bg-white rounded-md py-2.5 px-3 flex items-center gap-2 text-sm transition font-medium shadow-sm text-gray-700"><i class="fa-solid fa-plus text-gray-400"></i> New Chat</button>
            </div>
            <div class="flex-1 overflow-y-auto px-3 py-2 space-y-1 custom-scroll">
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider px-2 mt-4 mb-1">Productivity</div>
                <button onclick="openTool('todo')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-check-circle w-4 text-blue-500"></i> Reminders</button>
                <button onclick="openTool('notes')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-note-sticky w-4 text-yellow-500"></i> Notes</button>

                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider px-2 mt-6 mb-1">Tools</div>
                <button onclick="openTool('summaries')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-globe w-4 text-gray-500"></i> Tax Summaries</button>
                <button onclick="openTool('email')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-envelope-open-text w-4 text-gray-500"></i> Correspondence</button>
                <button onclick="openTool('salary')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-calculator w-4 text-gray-500"></i> Salary Calculator</button>
                <button onclick="triggerUpload()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-700"><i class="fa-solid fa-file-pdf w-4 text-gray-500"></i> Document Helper</button>
                
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider px-2 mt-6 mb-1">History</div>
                <div id="history-list" class="space-y-1"></div>
            </div>
            <div class="p-3 border-t border-gray-200">
                <button onclick="switchView('landing')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-500"><i class="fa-solid fa-right-from-bracket w-4"></i> Exit App</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-white">
            <header class="h-14 border-b border-gray-100 flex items-center justify-between px-6 bg-white/95 backdrop-blur z-10">
                <div class="font-semibold text-gray-700 cursor-pointer" onclick="resetChat()">TaxLLM <span class="bg-gray-100 text-gray-500 text-[10px] px-1.5 py-0.5 rounded ml-2">PRO</span></div>
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="toggleMode()"><span class="text-gray-400 text-xs">Simple</span><i class="fa-solid fa-toggle-on text-black text-xl" id="mode-icon"></i><span class="font-medium text-xs">Expert</span></div>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-6 pb-40 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto animate-fade-in">
                    <div class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center text-3xl mb-6 text-gray-400 border border-gray-100"><i class="fa-solid fa-scale-balanced"></i></div>
                    <h2 class="text-2xl font-semibold mb-2 text-gray-900">How can I help with your taxes?</h2>
                    <div class="grid grid-cols-2 gap-4 w-full mt-8">
                        <button onclick="openTool('salary')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition bg-white group"><div class="font-bold text-sm mb-1 text-gray-800 group-hover:text-blue-600">Salary Calculator</div><div class="text-xs text-gray-400">Calculate net pay</div></button>
                        <button onclick="openTool('email')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition bg-white group"><div class="font-bold text-sm mb-1 text-gray-800 group-hover:text-purple-600">Email Generator</div><div class="text-xs text-gray-400">Draft letters</div></button>
                    </div>
                </div>
                <div id="tool-view" class="hidden max-w-xl mx-auto mt-4 bg-white p-8 rounded-3xl border border-gray-200 shadow-lg"></div>
                <div id="chat-output" class="max-w-3xl mx-auto space-y-8 hidden pt-4"></div>
                <div id="loading" class="hidden max-w-3xl mx-auto pt-4 flex gap-4 items-center"><div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500"><i class="fa-solid fa-bolt text-xs"></i></div><div class="text-sm text-gray-500 font-medium">Thinking...</div></div>
            </div>

            <div class="absolute bottom-0 w-full bg-white pt-4 pb-8 px-6 border-t border-gray-100">
                <div class="max-w-3xl mx-auto relative">
                    <div class="relative shadow-sm rounded-xl border border-gray-300 bg-white focus-within:border-gray-500 focus-within:ring-1 focus-within:ring-gray-500 transition">
                        <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" onchange="handleFileUpload(this)">
                        <textarea id="user-input" rows="1" class="w-full p-4 pr-24 resize-none focus:outline-none text-sm max-h-40 rounded-xl" placeholder="Ask TaxLLM..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        <div class="absolute right-2 bottom-2 flex gap-1">
                            <button id="stop-btn" onclick="stopGeneration()" class="hidden bg-gray-200 text-black w-8 h-8 rounded-lg hover:bg-gray-300 transition flex items-center justify-center"><i class="fa-solid fa-stop text-xs"></i></button>
                            <button id="send-btn" onclick="sendMessage()" class="bg-black text-white w-8 h-8 rounded-lg hover:bg-gray-800 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-[10px] text-gray-400">Answers are verified by official sources.</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let state = { mode: 'Expert', controller: null, history: [], todos: [], notes: [], lists: {'Personal': [], 'Work': []} };

        // --- CONTENT ---
        const contentData = {
            'about': { title: 'About TaxLLM', body: 'Our mission is to provide professional-grade tax intelligence using advanced AI. Built by <strong>Dharmil Mehta</strong>, Founder of TaxLLM.' },
            'security': { title: 'Data Security', body: 'Encryption in transit (TLS 1.3). No PII storage. Local-first history.' },
            'terms': { title: 'Terms of Service', body: 'Information only. Not legal advice. Verify all outputs.' },
            'contact': { title: 'Contact', body: 'Email: support@taxllm.pro' }
        };

        // --- UI ---
        function openContentModal(t) { document.getElementById('modal-title').innerHTML = contentData[t].title; document.getElementById('modal-content').innerHTML = contentData[t].body; document.getElementById('modal-info').classList.remove('hidden'); }
        function openModal(id) { document.getElementById('modal-' + id).classList.remove('hidden'); }
        function closeModals(e,f) { if(f || e.target.id.startsWith('modal-')) document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden')); }
        function switchView(v) { document.getElementById('landing-view').classList.toggle('hidden', v === 'app'); document.getElementById('app-view').classList.toggle('hidden', v !== 'app'); }
        function handleLandingSearch() { const q=document.getElementById('landing-search').value; if(q.trim()){ switchView('app'); document.getElementById('user-input').value=q; sendMessage(); } }
        function resetChat() { document.getElementById('welcome-screen').classList.remove('hidden'); document.getElementById('tool-view').classList.add('hidden'); document.getElementById('chat-output').classList.add('hidden'); document.getElementById('chat-output').innerHTML=''; }
        function toggleMode() { state.mode = state.mode==='Expert'?'Simple':'Expert'; document.getElementById('mode-icon').className = state.mode==='Expert'?'fa-solid fa-toggle-on text-black text-xl':'fa-solid fa-toggle-off text-gray-400 text-xl'; }
        function stopGeneration() { if(state.controller){state.controller.abort(); state.controller=null; document.getElementById('loading').classList.add('hidden'); document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden');} }
        function sendPreset(t) { document.getElementById('user-input').value=t; sendMessage(); }
        function scrollToSection(id) { const el=document.getElementById(id); if(el)el.scrollIntoView({behavior:'smooth'}); }

        // --- TOOLS ---
        function openTool(type) {
            document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.add('hidden');
            const view = document.getElementById('tool-view'); view.classList.remove('hidden');
            
            if(type === 'salary') {
                // Deep Salary Calculator
                view.innerHTML = `
                    <div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Salary Calculator</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">Country</label><select id="calc-country" class="w-full p-2 border rounded-lg" onchange="updateCalcFields()"><option value="UK">UK</option><option value="USA">USA</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">Gross Salary</label><input type="number" id="calc-amount" class="w-full p-2 border rounded-lg" placeholder="Amount"></div>
                        <div id="calc-extra-fields"></div>
                        <button onclick="calculateSalary()" class="w-full bg-black text-white py-2 rounded-lg">Calculate Breakdown</button>
                        <div id="calc-res" class="hidden bg-gray-50 p-4 rounded-lg mt-4 text-sm"></div>
                    </div>`;
                updateCalcFields();
            } else if(type === 'email') {
                view.innerHTML = `
                    <div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Correspondence</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="space-y-4">
                        <input type="text" id="email-to" class="w-full p-3 border rounded-lg" placeholder="Recipient Name">
                        <input type="text" id="email-purpose" class="w-full p-3 border rounded-lg" placeholder="Purpose (e.g. Late Filing Appeal)">
                        <input type="text" id="email-facts" class="w-full p-3 border rounded-lg" placeholder="Key Facts (Dates, Ref No)">
                        <select id="email-tone" class="w-full p-3 border rounded-lg"><option>Formal</option><option>Urgent</option><option>Apologetic</option></select>
                        <button onclick="sendPreset('Draft a ' + document.getElementById('email-tone').value + ' letter to ' + document.getElementById('email-to').value + ' regarding ' + document.getElementById('email-purpose').value + '. Key facts: ' + document.getElementById('email-facts').value)" class="w-full bg-black text-white py-2 rounded-lg">Generate</button>
                    </div>`;
            } else if(type === 'summaries') {
                view.innerHTML = `
                    <div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Deep Tax Summaries</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-gray-500">Jurisdiction</label>
                        <select id="sum-country" class="w-full p-3 border rounded-lg"><option>UK</option><option>USA</option><option>UAE</option><option>India</option><option>Canada</option></select>
                        <label class="block text-xs font-bold text-gray-500">Category</label>
                        <select id="sum-cat" class="w-full p-3 border rounded-lg">
                            <option>Corporate Income Tax</option><option>VAT / GST</option><option>Withholding Tax (WHT)</option><option>Transfer Pricing</option><option>R&D Incentives</option><option>Capital Gains</option><option>Payroll Taxes</option><option>Crypto Assets</option><option>Property Tax</option><option>Tax Treaties</option>
                        </select>
                        <button onclick="sendPreset('Provide a detailed tax summary for ' + document.getElementById('sum-country').value + ' regarding ' + document.getElementById('sum-cat').value + '. Use a table.')" class="w-full bg-black text-white py-2 rounded-lg">Fetch Data</button>
                    </div>`;
            } else if(type === 'todo') { renderTodo(view); } 
              else if(type === 'notes') { renderNotes(view); }
        }

        // --- CALCULATOR LOGIC ---
        function updateCalcFields() {
            const c = document.getElementById('calc-country').value;
            const div = document.getElementById('calc-extra-fields');
            if(c === 'UK') div.innerHTML = `<label class="flex items-center gap-2 text-sm"><input type="checkbox" id="calc-student"> Student Loan (Plan 2)</label>`;
            else if(c === 'USA') div.innerHTML = `<label class="flex items-center gap-2 text-sm"><input type="checkbox" id="calc-401k"> 401k Contribution (5%)</label>`;
        }

        function calculateSalary() {
            const c = document.getElementById('calc-country').value;
            const gross = parseFloat(document.getElementById('calc-amount').value);
            let tax = 0, ni = 0, net = 0;
            
            // Demo Logic (Simplified 2025 rates)
            if(c === 'UK') {
                tax = gross > 12570 ? (gross - 12570) * 0.2 : 0;
                ni = gross > 12570 ? (gross - 12570) * 0.08 : 0;
                if(document.getElementById('calc-student').checked && gross > 27295) tax += (gross - 27295) * 0.09;
            } else {
                tax = gross * 0.22; // Flat est for US
                ni = gross * 0.0765; // FICA
            }
            net = gross - tax - ni;
            
            document.getElementById('calc-res').classList.remove('hidden');
            document.getElementById('calc-res').innerHTML = `
                <div class="flex justify-between border-b pb-2 mb-2"><span>Gross</span><span>${gross.toFixed(0)}</span></div>
                <div class="flex justify-between text-red-500"><span>Tax</span><span>-${tax.toFixed(0)}</span></div>
                <div class="flex justify-between text-red-500 mb-2"><span>${c==='UK'?'NI':'FICA'}</span><span>-${ni.toFixed(0)}</span></div>
                <div class="flex justify-between font-bold text-lg border-t pt-2"><span>Net Pay</span><span>${net.toFixed(0)}</span></div>
            `;
        }

        // --- REMINDERS (APPLE STYLE) ---
        function renderTodo(container) {
            // Initialize data structure if empty
            if (!state.lists['Personal']) state.lists = {'Personal': [], 'Work': []};
            
            let activeList = localStorage.getItem('tax_active_list') || 'Work';
            const todos = state.lists[activeList] || [];
            
            const itemsHtml = todos.map((t, i) => 
                `<div class="flex items-center gap-3 p-3 bg-white border-b border-gray-100 last:border-0 group">
                    <input type="checkbox" ${t.done?'checked':''} onclick="toggleTodo('${activeList}', ${i})" class="w-5 h-5 rounded-full border-2 border-gray-300 appearance-none cursor-pointer checked:bg-blue-500 checked:border-blue-500 relative checked:after:content-['âœ“'] checked:after:text-white checked:after:text-xs checked:after:absolute checked:after:top-0.5 checked:after:left-1">
                    <span class="text-sm text-gray-700 ${t.done?'line-through text-gray-400':''}">${t.text}</span>
                    <button onclick="deleteTodo('${activeList}', ${i})" class="ml-auto text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                </div>`
            ).join('');

            container.innerHTML = `
                <div class="flex justify-between mb-4 items-center">
                    <div class="flex gap-2">
                        <button onclick="switchList('Work')" class="px-3 py-1 rounded-full text-xs font-bold ${activeList==='Work'?'bg-black text-white':'bg-gray-100 text-gray-500'}">Work</button>
                        <button onclick="switchList('Personal')" class="px-3 py-1 rounded-full text-xs font-bold ${activeList==='Personal'?'bg-black text-white':'bg-gray-100 text-gray-500'}">Personal</button>
                    </div>
                    <button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <h2 class="text-2xl font-bold mb-4 text-blue-600">${activeList}</h2>
                <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden mb-4">${itemsHtml || '<p class="p-4 text-xs text-gray-400 text-center">No reminders</p>'}</div>
                <div class="relative">
                    <input type="text" id="new-todo" class="w-full p-3 pr-12 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="New Reminder" onkeydown="if(event.key==='Enter')addTodo('${activeList}')">
                    <button onclick="addTodo('${activeList}')" class="absolute right-2 top-2 w-8 h-8 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fa-solid fa-plus"></i></button>
                </div>`;
        }
        function switchList(name) { localStorage.setItem('tax_active_list', name); renderTodo(document.getElementById('tool-view')); }
        function addTodo(listName) { const txt=document.getElementById('new-todo').value; if(txt){ state.lists[listName].push({text:txt, done:false}); renderTodo(document.getElementById('tool-view')); } }
        function toggleTodo(list, idx) { state.lists[list][idx].done = !state.lists[list][idx].done; renderTodo(document.getElementById('tool-view')); }
        function deleteTodo(list, idx) { state.lists[list].splice(idx, 1); renderTodo(document.getElementById('tool-view')); }

        // --- NOTES (APPLE STYLE) ---
        function renderNotes(container) {
            let activeNote = parseInt(localStorage.getItem('tax_active_note') || 0);
            // Default notes if empty
            if (state.notes.length === 0) state.notes = [{title: "New Note", body: ""}];
            
            const sidebarHtml = state.notes.map((n,i) => 
                `<div onclick="selectNote(${i})" class="p-3 border-b border-gray-100 cursor-pointer hover:bg-yellow-50 ${i===activeNote?'bg-yellow-100':''}">
                    <div class="font-bold text-xs text-gray-800 truncate">${n.title || 'New Note'}</div>
                    <div class="text-[10px] text-gray-400 truncate">${n.body.substring(0,20)}...</div>
                </div>`
            ).join('');

            container.innerHTML = `
                <div class="flex h-[400px] border border-gray-200 rounded-xl overflow-hidden">
                    <div class="w-1/3 border-r border-gray-200 bg-gray-50 flex flex-col">
                        <div class="p-2 border-b border-gray-200 flex justify-between items-center"><span class="text-xs font-bold text-gray-500">iCloud</span><button onclick="createNote()" class="text-yellow-500 hover:text-yellow-600"><i class="fa-regular fa-pen-to-square"></i></button></div>
                        <div class="flex-1 overflow-y-auto">${sidebarHtml}</div>
                    </div>
                    <div class="w-2/3 bg-white flex flex-col">
                         <div class="flex justify-end p-2"><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                         <input type="text" id="note-title" class="px-4 py-2 font-bold text-lg outline-none" value="${state.notes[activeNote].title}" oninput="updateNote(${activeNote})">
                         <textarea id="note-body" class="flex-1 p-4 resize-none outline-none text-sm text-gray-600 font-mono" oninput="updateNote(${activeNote})">${state.notes[activeNote].body}</textarea>
                         <div class="p-2 border-t flex justify-between text-xs text-gray-400"><span>${new Date().toLocaleDateString()}</span><button onclick="deleteNote(${activeNote})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                </div>`;
        }
        function selectNote(i) { localStorage.setItem('tax_active_note', i); renderNotes(document.getElementById('tool-view')); }
        function createNote() { state.notes.push({title: "New Note", body: ""}); selectNote(state.notes.length-1); }
        function updateNote(i) { state.notes[i].title = document.getElementById('note-title').value; state.notes[i].body = document.getElementById('note-body').value; }
        function deleteNote(i) { if(state.notes.length > 1) { state.notes.splice(i,1); selectNote(0); } else { state.notes=[{title:"",body:""}]; renderNotes(document.getElementById('tool-view')); } }

        // --- CHAT ---
        function triggerUpload() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { 
             if (input.files[0]) {
                switchView('app'); document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.remove('hidden');
                document.getElementById('chat-output').insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-gray-100 text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">ðŸ“„ ${input.files[0].name}</div></div>`);
                document.getElementById('loading').classList.remove('hidden');
                Tesseract.recognize(input.files[0], 'eng').then(({ data: { text } }) => {
                     document.getElementById('loading').classList.add('hidden');
                     document.getElementById('user-input').value = `Analyze: "${text.substring(0, 300)}..."`;
                     sendMessage();
                });
             }
        }
        async function sendMessage() {
            const input = document.getElementById('user-input'); const text = input.value.trim(); if(!text) return;
            state.controller = new AbortController();
            document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('tool-view').classList.add('hidden');
            const output = document.getElementById('chat-output'); output.classList.remove('hidden');
            document.getElementById('send-btn').classList.add('hidden'); document.getElementById('stop-btn').classList.remove('hidden');

            output.insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-[#F7F7F8] text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">${text}</div></div>`);
            input.value = ''; window.scrollTo(0, document.body.scrollHeight);
            document.getElementById('loading').classList.remove('hidden');

            try {
                const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: `You are TaxLLM. MODE: ${state.mode}. QUERY: ${text}` }), signal: state.controller.signal });
                const data = await res.json();
                document.getElementById('loading').classList.add('hidden');
                const msgId = Date.now();
                output.insertAdjacentHTML('beforeend', `<div class="flex gap-4 group fade-in"><div class="w-8 h-8 bg-green-600 text-white rounded-sm flex items-center justify-center flex-shrink-0 text-xs font-bold">T</div><div class="flex-1 max-w-3xl"><div class="prose prose-sm text-gray-800 leading-7 mb-2" id="content-${msgId}">${marked.parse(data.response)}</div><div class="flex gap-2 items-center opacity-0 group-hover:opacity-100 transition"><button onclick="navigator.clipboard.writeText(document.getElementById('content-${msgId}').innerText)" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Copy</button><button onclick="document.getElementById('user-input').value='Simplify this';sendMessage()" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Simplify</button></div></div></div>`);
                if(state.history[0] !== text) { state.history.unshift(text); renderHistory(); }
            } catch(err) { if(err.name !== 'AbortError') document.getElementById('loading').classList.add('hidden'); }
            finally { document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden'); state.controller = null; scrollToBottom(); }
        }
        function renderHistory() { const l = document.getElementById('history-list'); l.innerHTML = ''; state.history.forEach(t => { const b = document.createElement('button'); b.className = "w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg truncate transition mb-1"; b.innerHTML = t; b.onclick = () => { resetChat(); document.getElementById('user-input').value = t; sendMessage(); }; l.appendChild(b); }); }
    </script>
</body>
</html>
