<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxGPT Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%); }
        .chat-container { height: 70vh; }
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background: #4f46e5; color: #eef2ff; border-radius: 14px 14px 2px 14px; }
        .ai-message { background: #ffffff; color: #111827; border-radius: 14px 14px 14px 2px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; }
        .text-primary { color: #4f46e5; }
        .bg-primary { background: #4f46e5; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl overflow-hidden border border-gray-200">
        <div class="p-6 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white">
            <h1 class="text-2xl font-bold">TaxGPT</h1>
            <p class="text-sm text-indigo-100">Expert AI tax assistant with grounded, up-to-date answers.</p>
        </div>

        <div class="p-6 space-y-4">
            <div id="apiKeyWarning" class="hidden p-3 rounded-xl border border-yellow-300 bg-yellow-50 text-yellow-900 text-sm flex items-start space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-11.5a.75.75 0 011.5 0v4a.75.75 0 01-1.5 0v-4zm.75 8.75a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
                <p class="leading-relaxed">Add your Gemini API key to the <code class="font-mono">API_KEY</code> constant in this page to enable sending questions.</p>
            </div>
            <div class="p-3 rounded-xl border border-indigo-100 bg-indigo-50 text-indigo-900 text-sm leading-relaxed">
                <p class="font-semibold text-indigo-700">How to run this page</p>
                <ol class="list-decimal list-inside mt-1 space-y-1">
                    <li>Open <code class="font-mono">index.html</code> from this folderâ€”no extra files are needed.</li>
                    <li>Edit the <code class="font-mono">API_KEY</code> value near the bottom of the file and paste your Gemini key between the quotes.</li>
                    <li>Start a local server (for example, <code class="font-mono">python -m http.server 8000</code>) and visit <code class="font-mono">http://localhost:8000</code>.</li>
                    <li>Type your question and click <strong>Send</strong>. The banner disappears once a key is present.</li>
                </ol>
            </div>
            <div id="chatHistory" class="chat-container overflow-y-auto space-y-3 pr-2"></div>

            <div class="flex items-start space-x-3">
                <textarea id="userInput" class="flex-1 p-3 border border-gray-200 rounded-xl shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Ask a tax question..." aria-label="Tax question"></textarea>
                <button id="sendButton" class="bg-primary text-white px-4 py-3 rounded-xl font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" type="button">Send</button>
            </div>

            <div id="loadingIndicator" class="hidden text-sm text-gray-500 flex items-center space-x-2">
                <svg class="animate-spin h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span>Fetching grounded answer...</span>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_KEY = ""; 
        const API_KEY = "";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const MAX_RETRIES = 5;
        let chatHistory = []; 
        let chatHistory = [];
        const SYSTEM_INSTRUCTION = "You are TaxGPT, an expert AI tax assistant. Your primary function is to provide accurate, up-to-date, and grounded tax information, leveraging Google Search. Respond professionally, using clear language. ALWAYS use the provided search results to formulate your answer. If a question is outside the scope of general tax law (e.g., highly specific personal advice), state clearly that you are an AI and recommend consulting a human tax professional. Present information in easy-to-read markdown format (e.g., bolding keywords, using lists).";

        // --- DOM Elements ---
        const chatHistoryDiv = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const apiKeyWarning = document.getElementById('apiKeyWarning');

        // --- Utility Functions ---

        /**
         * Renders a message to the chat history UI.
         * @param {string} role - 'user' or 'model'.
         * @param {string} text - The message text (can include markdown).
         * @param {Array} sources - Array of {uri, title} for grounding sources.
         */
        function renderMessage(role, text, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'fade-in');

            const isUser = role === 'user';
            

            messageWrapper.classList.add(isUser ? 'justify-end' : 'justify-start');

            const messageBubble = document.createElement('div');
            messageBubble.classList.add(
                isUser ? 'user-message' : 'ai-message',
                'p-4',
                'max-w-xl',
                'text-sm',
                'whitespace-pre-wrap',
                'break-words'
            );

            // Basic Markdown to HTML conversion
            let htmlText = text;
            // Handle lists, bold, and italic
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlText = htmlText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Simple list item conversion
            htmlText = htmlText.replace(/^- (.*)/gm, '<p class="pl-4 py-1 flex items-start"><span class="text-primary mr-2">&bull;</span><span>$1</span></p>');
            

            // Add sources/citations
            if (sources && sources.length > 0) {
                htmlText += '<div class="mt-3 pt-3 border-t border-gray-100">';
                htmlText += '<p class="text-xs font-semibold text-gray-500 mb-1">Sources:</p>';
                sources.forEach((source, index) => {
                    if (source.uri && source.title) {
                        // Truncate title for cleaner display
                        const displayTitle = source.title.length > 60 ? source.title.substring(0, 60) + '...' : source.title;
                        htmlText += `
                            <a href="${source.uri}" target="_blank" title="${source.title}" class="block text-xs text-primary hover:text-indigo-700 transition duration-150 mt-1">
                                <span class="font-semibold text-gray-600">${index + 1}.</span> ${displayTitle}
                            </a>
                        `;
                    }
                });
                htmlText += '</div>';
            }

            messageBubble.innerHTML = htmlText;
            messageWrapper.appendChild(messageBubble);
            chatHistoryDiv.appendChild(messageWrapper);
            

            // Scroll to the bottom
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        /**
         * Handles the API call with exponential backoff for retries.
         * @param {Object} payload - The request body.
         * @returns {Promise<Object>} The JSON response.
         */
        async function fetchWithRetry(payload) {
            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/\${MODEL_NAME}:generateContent?key=\${API_KEY}\`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        // Rate limit exceeded, apply exponential backoff
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // Do not log this retry as an error in the console
                    } else {
                        // Log API error for debugging
                        const errorBody = await response.text();
                        console.error(\`Attempt \${attempt + 1}: API call failed with status \${response.status}. Response: \${errorBody}\`);
                        throw new Error(\`API call failed with status: \${response.status}\`);
                        console.error(`Attempt ${attempt + 1}: API call failed with status ${response.status}. Response: ${errorBody}`);
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        // Log final failure after all retries
                        console.error(\`Final API fetch failed after \${MAX_RETRIES} attempts: \${error.message}\`);
                        throw new Error(\`Fetch failed after all retries.\`);
                        console.error(`Final API fetch failed after ${MAX_RETRIES} attempts: ${error.message}`);
                        throw new Error(`Fetch failed after all retries.`);
                    }
                    // For network errors or other transient issues, retry
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        

        /**
         * Processes the user query, calls the Gemini API, and updates the chat.
         * @param {string} userQuery - The user's input text.
         */
        async function getAiResponse(userQuery) {
            // 1. Prepare UI
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            userInput.disabled = true;
            userInput.value = ''; // Clear input immediately

            // 2. Add user message to history and UI
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            renderMessage('user', userQuery);

            // 3. Construct API Payload
            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION }]
                },
                // Enable Google Search grounding for up-to-date tax information
                tools: [{ "google_search": {} }],
            };

            let aiResponseText = "Sorry, I encountered a connection or API error while fetching the response. Please check your network connection and try asking again.";
            let sources = [];
            

            try {
                // 4. Call the API
                const result = await fetchWithRetry(payload);
                

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                    

                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                } else {
                    // This handles cases where the response is structured but contains no text (e.g., filtered content)
                    aiResponseText = "I could not generate a response for that query. The content may violate safety guidelines or the model failed to produce a valid output.";
                    console.warn("API response was empty or filtered:", result);
                }

            } catch (error) {
                console.error("Error during API communication:", error);
                // aiResponseText remains the default error message
            } finally {
                // 5. Update Chat History and UI
                

                // Add the model's final response to the conversation history
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                // Render the model's response
                renderMessage('model', aiResponseText, sources);

                // Reset UI
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        /**
         * Handles the main send action (button click or Enter key press).
         */
        function handleSend() {
            const query = userInput.value.trim();

            // Surface a clear error if the API key is missing to avoid silent failures.
            if (!API_KEY || API_KEY.trim() === '') {
                renderMessage('model', 'Please add your Gemini API key to the page before sending a request.');
                return;
            }

            if (query && !sendButton.disabled) { // Prevent double-send
                getAiResponse(query);
            }
        }

        function showApiKeyWarningIfNeeded() {
            if (!API_KEY || API_KEY.trim() === '') {
                apiKeyWarning.classList.remove('hidden');
            } else {
                apiKeyWarning.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault(); // Prevent default form submission if applicable
                handleSend();
            }
        });

        // Initial focus on load
        window.onload = () => {
            userInput.focus();
            showApiKeyWarningIfNeeded();
        };

    </script>
</body>
</html>
