<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxLLM | Professional Tax Intelligence</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    colors: { appleGray: '#F5F5F7', appleDark: '#1D1D1F', appleBlue: '#0066CC' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; letter-spacing: -0.01em; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* APPLE STYLE PROSE CONFIGURATION */
        .prose { color: #1d1d1f; font-size: 0.95rem; line-height: 1.65; }
        
        /* Headings */
        .prose h3 { 
            font-weight: 600; 
            font-size: 1.1rem; 
            margin-top: 1.5em; 
            margin-bottom: 0.75em; 
            color: #1d1d1f; 
            letter-spacing: -0.015em;
        }
        
        /* Paragraphs */
        .prose p { margin-bottom: 1em; color: #333336; }
        
        /* Strong/Bold */
        .prose strong { font-weight: 600; color: #000; }
        
        /* Links */
        .prose a { color: #0066CC; text-decoration: none; transition: opacity 0.2s; }
        .prose a:hover { opacity: 0.7; }

        /* Citations (The "Source+1" look) */
        .citation-badge {
            display: inline-flex;
            align-items: center;
            background-color: #f5f5f7;
            border: 1px solid #e5e5ea;
            border-radius: 4px;
            padding: 0px 6px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #6e6e73;
            margin-left: 6px;
            vertical-align: middle;
            cursor: default;
        }

        /* Loading Dots */
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #888; animation: dot-flashing 1s infinite alternate; }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #888; } 50%, 100% { background-color: #ccc; } }
    </style>
</head>
<body class="bg-white text-appleDark">

    <div id="modal-library" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-4xl m-4 animate-fade-in max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Official Tax Library</h3>
                <button onclick="closeModals(null, true)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="https://www.gov.uk/government/organisations/hm-revenue-customs" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group">
                    <div class="font-bold group-hover:text-blue-600">ðŸ‡¬ðŸ‡§ UK</div><div class="text-xs text-gray-500">HMRC</div>
                </a>
                <a href="https://www.irs.gov/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group">
                    <div class="font-bold group-hover:text-blue-600">ðŸ‡ºðŸ‡¸ USA</div><div class="text-xs text-gray-500">IRS</div>
                </a>
                <a href="https://tax.gov.ae/en" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group">
                    <div class="font-bold group-hover:text-blue-600">ðŸ‡¦ðŸ‡ª UAE</div><div class="text-xs text-gray-500">FTA</div>
                </a>
                <a href="https://incometaxindia.gov.in/" target="_blank" class="p-4 border rounded-xl hover:bg-gray-50 hover:border-blue-500 transition group">
                    <div class="font-bold group-hover:text-blue-600">ðŸ‡®ðŸ‡³ India</div><div class="text-xs text-gray-500">ITD</div>
                </a>
            </div>
        </div>
    </div>

    <div id="modal-info" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeModals(event)">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg m-4 animate-fade-in relative">
            <button onclick="closeModals(null, true)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Title</h3>
            <div id="modal-content" class="prose text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="landing-view">
        <nav class="fixed w-full z-50 glass-nav transition-all duration-300">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 font-bold text-xl tracking-tight text-gray-900 cursor-pointer" onclick="location.reload()">
                    <i class="fa-solid fa-scale-balanced text-black"></i> TaxLLM
                </div>
                <div class="hidden md:flex space-x-8 text-sm font-medium text-gray-600">
                    <a href="#" onclick="scrollToSection('features')" class="hover:text-black transition">Features</a>
                    <a href="#" onclick="scrollToSection('pricing')" class="hover:text-black transition">Pricing</a>
                    <button onclick="openModal('library')" class="hover:text-black transition">Library</button>
                </div>
                <div class="flex gap-3 text-sm">
                    <button onclick="switchView('app')" class="bg-black text-white px-5 py-2 rounded-full font-medium hover:bg-gray-800 transition transform hover:scale-105">Launch App</button>
                </div>
            </div>
        </nav>

        <section class="pt-40 pb-20 px-6 text-center max-w-5xl mx-auto animate-fade-in">
            <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 leading-tight text-gray-900">Your AI Tax Expert.</h1>
            <p class="text-xl md:text-2xl text-gray-500 font-light mb-10 max-w-3xl mx-auto">Accurate. Cited. Country-specific. Trusted by professionals.</p>
            
            <div class="relative max-w-2xl mx-auto mb-20 group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><i class="fa-solid fa-magnifying-glass text-gray-400 text-lg"></i></div>
                <input type="text" id="landing-search" class="w-full pl-14 pr-14 py-5 rounded-full border border-gray-200 shadow-lg text-lg focus:outline-none focus:ring-4 focus:ring-gray-100 transition" placeholder="Ask anything about tax..." onkeydown="if(event.key === 'Enter') handleLandingSearch()">
                <button onclick="handleLandingSearch()" class="absolute right-2 top-2 bg-black text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-800 transition shadow-md"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </section>

        <section id="features" class="bg-white py-20 px-6 border-t border-gray-100">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16"><h2 class="text-3xl font-bold">Everything You Need for Tax</h2><p class="text-gray-500 mt-2">Powerful tools integrated into one workspace.</p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-magnifying-glass text-gray-600 text-xl"></i> <span class="font-medium">Tax Search</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-globe text-gray-600 text-xl"></i> <span class="font-medium">Country Summaries</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-envelope-open-text text-gray-600 text-xl"></i> <span class="font-medium">Email Generator</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-file-pdf text-gray-600 text-xl"></i> <span class="font-medium">Document Helper</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-gavel text-gray-600 text-xl"></i> <span class="font-medium">Case Law Explorer</span></div>
                    <div class="p-6 border border-gray-100 rounded-2xl hover:shadow-lg transition flex items-center gap-4"><i class="fa-solid fa-scale-balanced text-gray-600 text-xl"></i> <span class="font-medium">Comparisons</span></div>
                </div>
            </div>
        </section>
        
        <footer class="py-12 border-t border-gray-100 text-center text-sm text-gray-500 bg-white">
            <div class="flex justify-center gap-8 mb-6">
                <button onclick="openContentModal('about')" class="hover:text-black">About</button>
                <button onclick="openContentModal('security')" class="hover:text-black">Security</button>
                <button onclick="openContentModal('terms')" class="hover:text-black">Terms</button>
                <button onclick="openContentModal('contact')" class="hover:text-black">Contact</button>
            </div>
            <p>&copy; 2025 TaxLLM. Built by Dharmil Mehta.</p>
        </footer>
    </div>

    <div id="app-view" class="hidden h-screen flex bg-white font-sans text-gray-900">
        <aside class="w-[260px] bg-[#fbfbfd] text-gray-700 flex flex-col h-full border-r border-gray-200 flex-shrink-0">
            <div class="p-4 flex items-center gap-2 font-bold text-lg border-b border-gray-100 h-14">
                <i class="fa-solid fa-scale-balanced text-black"></i> TaxLLM <span class="text-xs bg-black text-white px-1.5 py-0.5 rounded">PRO</span>
            </div>
            <div class="p-3">
                <button onclick="resetChat()" class="w-full bg-white border border-gray-200 hover:border-gray-300 text-gray-800 rounded-lg py-2.5 px-3 flex items-center gap-2 text-sm transition font-medium shadow-sm">
                    <i class="fa-solid fa-plus text-gray-400"></i> New Chat
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-3 py-2 space-y-1 custom-scroll">
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider px-2 mt-4 mb-1">Tools</div>
                <button onclick="openTool('summaries')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left"><i class="fa-solid fa-globe w-4 text-gray-500"></i> Tax Summaries</button>
                <button onclick="openTool('email')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left"><i class="fa-solid fa-envelope-open-text w-4 text-gray-500"></i> Letter Generator</button>
                <button onclick="openTool('salary')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left"><i class="fa-solid fa-calculator w-4 text-gray-500"></i> Salary Calculator</button>
                <button onclick="triggerUpload()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left"><i class="fa-solid fa-file-pdf w-4 text-gray-500"></i> Document Helper</button>
                
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider px-2 mt-6 mb-1">History</div>
                <div id="history-list" class="space-y-1"></div>
            </div>
            <div class="p-3 border-t border-gray-200">
                <button onclick="switchView('landing')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition text-left text-gray-500">
                    <i class="fa-solid fa-right-from-bracket w-4"></i> Exit
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-white">
            <header class="h-14 border-b border-gray-100 flex items-center justify-between px-6 bg-white/95 backdrop-blur z-10">
                <div class="font-medium text-sm text-gray-500">Professional Workspace</div>
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2 cursor-pointer select-none" onclick="toggleMode()">
                        <span class="text-gray-400 text-xs">Simple</span><i class="fa-solid fa-toggle-on text-black text-xl" id="mode-icon"></i><span class="font-medium text-xs">Expert</span>
                    </div>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-6 pb-40 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto animate-fade-in">
                    <div class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center text-3xl mb-6 text-gray-400 border border-gray-100"><i class="fa-solid fa-scale-balanced"></i></div>
                    <h2 class="text-2xl font-semibold mb-2 text-gray-900">How can I help with your taxes?</h2>
                    <div class="grid grid-cols-2 gap-4 w-full mt-8">
                        <button onclick="sendPreset('Summarize 2025 Corporate Tax rates for UK')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition bg-white"><div class="font-bold text-sm mb-1 text-gray-800">Summarize Rates</div><div class="text-xs text-gray-400">Corporate tax info</div></button>
                        <button onclick="sendPreset('Draft a penalty appeal letter')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 hover:border-gray-300 transition bg-white"><div class="font-bold text-sm mb-1 text-gray-800">Draft Appeal</div><div class="text-xs text-gray-400">Professional letter</div></button>
                    </div>
                </div>
                
                <div id="tool-view" class="hidden max-w-xl mx-auto mt-4 bg-white p-8 rounded-3xl border border-gray-200 shadow-lg"></div>

                <div id="chat-output" class="max-w-3xl mx-auto space-y-8 hidden pt-4"></div>
                <div id="loading" class="hidden max-w-3xl mx-auto pt-4 flex gap-4 items-center"><div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500"><i class="fa-solid fa-bolt text-xs"></i></div><div class="text-sm text-gray-500 font-medium">Generating report...</div></div>
            </div>

            <div class="absolute bottom-0 w-full bg-white pt-4 pb-8 px-6 border-t border-gray-100">
                <div class="max-w-3xl mx-auto relative">
                    <div class="relative shadow-sm rounded-xl border border-gray-300 bg-white focus-within:border-gray-500 focus-within:ring-1 focus-within:ring-gray-500 transition">
                        <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" onchange="handleFileUpload(this)">
                        <textarea id="user-input" rows="1" class="w-full p-4 pr-24 resize-none focus:outline-none text-sm max-h-40 rounded-xl" placeholder="Ask TaxLLM..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        <div class="absolute right-2 bottom-2 flex gap-1">
                            <button id="stop-btn" onclick="stopGeneration()" class="hidden bg-gray-200 text-black w-8 h-8 rounded-lg hover:bg-gray-300 transition flex items-center justify-center"><i class="fa-solid fa-stop text-xs"></i></button>
                            <button id="send-btn" onclick="sendMessage()" class="bg-black text-white w-8 h-8 rounded-lg hover:bg-gray-800 transition flex items-center justify-center"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-[10px] text-gray-400">Answers are verified by official sources.</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let state = { mode: 'Expert', controller: null, history: [] };

        // --- MODAL DATA ---
        const contentData = {
            'about': { title: 'About TaxLLM', body: 'Built by <strong>Dharmil Mehta</strong>, Founder of TaxLLM. Our mission is to bridge the gap between complex tax legislation and modern AI. TaxLLM provides accurate, cited, and instant tax answers for professionals.' },
            'security': { title: 'Data Security', body: 'We utilize industry-standard encryption (TLS 1.3) for all data in transit. We do not store sensitive personally identifiable information (PII) or financial records on our servers. All AI interactions are stateless and anonymized.' },
            'terms': { title: 'Terms of Service', body: 'Disclaimer: TaxLLM provides information, not legal advice. Always verify outputs with a qualified accountant or tax advisor. By using this tool, you agree to our terms of service. Limitation of Liability applies.' },
            'contact': { title: 'Contact Us', body: 'For general inquiries, partnerships, or support, please reach out.<br><br><strong>Email:</strong> dharmil@taxllm.pro<br><strong>Response Time:</strong> Within 24 hours.' }
        };

        // --- UI FUNCTIONS ---
        function openContentModal(type) {
            document.getElementById('modal-title').innerHTML = contentData[type].title;
            document.getElementById('modal-content').innerHTML = contentData[type].body;
            document.getElementById('modal-info').classList.remove('hidden');
        }
        function openModal(id) { document.getElementById('modal-' + id).classList.remove('hidden'); }
        function closeModals(e, force) { if(force || e.target.id.startsWith('modal-')) document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden')); }
        function switchView(view) { document.getElementById('landing-view').classList.toggle('hidden', view === 'app'); document.getElementById('app-view').classList.toggle('hidden', view !== 'app'); }
        function handleLandingSearch() { const q = document.getElementById('landing-search').value; if(q.trim()) { switchView('app'); document.getElementById('user-input').value = q; sendMessage(); } }
        function resetChat() { document.getElementById('welcome-screen').classList.remove('hidden'); document.getElementById('tool-view').classList.add('hidden'); document.getElementById('chat-output').classList.add('hidden'); document.getElementById('chat-output').innerHTML = ''; }
        function toggleMode() { state.mode = state.mode === 'Expert' ? 'Simple' : 'Expert'; document.getElementById('mode-icon').className = state.mode === 'Expert' ? 'fa-solid fa-toggle-on text-black text-xl' : 'fa-solid fa-toggle-off text-gray-400 text-xl'; }
        function stopGeneration() { if(state.controller) { state.controller.abort(); state.controller = null; document.getElementById('loading').classList.add('hidden'); document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden'); } }
        function sendPreset(t) { document.getElementById('user-input').value = t; sendMessage(); }
        function scrollToSection(id) { document.getElementById(id).scrollIntoView({behavior: 'smooth'}); }

        // --- TOOL FUNCTIONS ---
        function openTool(type) {
            document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.add('hidden');
            const view = document.getElementById('tool-view'); view.classList.remove('hidden');
            
            if(type === 'salary') {
                view.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Salary Calculator</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div><div class="space-y-4"><input type="number" id="calc-amount" class="w-full p-3 border rounded-lg" placeholder="Gross Annual Income"><button onclick="document.getElementById('calc-res').innerHTML='Net: '+(document.getElementById('calc-amount').value*0.8).toFixed(0)" class="w-full bg-black text-white py-2 rounded-lg">Calculate</button><div id="calc-res" class="text-center font-bold text-xl mt-4"></div></div>`;
            } else if(type === 'email') {
                view.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Letter Generator</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div><div class="space-y-4"><input type="text" id="email-to" class="w-full p-3 border rounded-lg" placeholder="Recipient (e.g. HMRC)"><input type="text" id="email-purpose" class="w-full p-3 border rounded-lg" placeholder="Purpose (e.g. Appeal)"><select id="email-tone" class="w-full p-3 border rounded-lg"><option>Formal</option><option>Urgent</option></select><button onclick="sendPreset('Draft a ' + document.getElementById('email-tone').value + ' letter to ' + document.getElementById('email-to').value + ' regarding ' + document.getElementById('email-purpose').value)" class="w-full bg-black text-white py-2 rounded-lg">Generate</button></div>`;
            } else if(type === 'summaries') {
                 view.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-xl font-bold">Deep Tax Summaries</h2><button onclick="resetChat()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div><div class="space-y-4"><select id="sum-country" class="w-full p-3 border rounded-lg"><option>UK</option><option>USA</option><option>UAE</option><option>India</option></select><select id="sum-cat" class="w-full p-3 border rounded-lg"><option>Corporate Tax</option><option>VAT/Sales Tax</option><option>Withholding Tax</option><option>Transfer Pricing</option><option>R&D Credits</option><option>Employment Tax</option></select><button onclick="sendPreset('Provide a detailed tax summary for ' + document.getElementById('sum-country').value + ' regarding ' + document.getElementById('sum-cat').value + '. Use a table.')" class="w-full bg-black text-white py-2 rounded-lg">Fetch Data</button></div>`;
            }
        }

        function triggerUpload() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { 
             if (input.files && input.files[0]) {
                switchView('app'); document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('chat-output').classList.remove('hidden');
                document.getElementById('chat-output').insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-gray-100 text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">ðŸ“„ File: ${input.files[0].name}</div></div>`);
                document.getElementById('loading').classList.remove('hidden');
                Tesseract.recognize(input.files[0], 'eng').then(({ data: { text } }) => {
                     document.getElementById('loading').classList.add('hidden');
                     document.getElementById('user-input').value = `Analyze this document text: "${text.substring(0, 500)}..."`;
                     sendMessage();
                });
             }
        }

        // --- CHAT LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('user-input'); const text = input.value.trim(); if(!text) return;
            state.controller = new AbortController();
            document.getElementById('welcome-screen').classList.add('hidden'); document.getElementById('tool-view').classList.add('hidden');
            const output = document.getElementById('chat-output'); output.classList.remove('hidden');
            document.getElementById('send-btn').classList.add('hidden'); document.getElementById('stop-btn').classList.remove('hidden');

            output.insertAdjacentHTML('beforeend', `<div class="flex justify-end"><div class="bg-gray-100 text-gray-800 px-5 py-3 rounded-2xl max-w-xl text-sm leading-relaxed">${text}</div></div>`);
            input.value = ''; window.scrollTo(0, document.body.scrollHeight);
            document.getElementById('loading').classList.remove('hidden');

            try {
                // UPDATED SYSTEM PROMPT TO FORCE APPLE-STYLE FORMATTING
                const promptText = `You are TaxLLM. 
                FORMAT RULES:
                1. Use this EXACT structure:
                ### Key Facts
                (Bullet points)
                ### Scope & Thresholds
                (Details)
                ### Practical Implications
                (Advice)
                ### Sources
                [Source 1] [Source 2] (Use bracket notation like [HMRC])

                MODE: ${state.mode}.
                User Query: ${text}`;

                const res = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: promptText }),
                    signal: state.controller.signal
                });
                const data = await res.json();
                document.getElementById('loading').classList.add('hidden');
                
                const msgId = Date.now();
                // Parse [Source] into Citation Badges
                let formattedResp = marked.parse(data.response);
                formattedResp = formattedResp.replace(/\[(.*?)\]/g, '<span class="citation-badge">$1</span>');

                output.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-4 group fade-in">
                        <div class="w-8 h-8 bg-gray-900 text-white rounded-lg flex items-center justify-center flex-shrink-0 text-xs font-bold">AI</div>
                        <div class="flex-1 max-w-3xl">
                            <div class="prose prose-sm text-gray-800 leading-7 mb-3" id="content-${msgId}">${formattedResp}</div>
                            <div class="flex gap-2 items-center opacity-0 group-hover:opacity-100 transition">
                                <button onclick="navigator.clipboard.writeText(document.getElementById('content-${msgId}').innerText)" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Copy</button>
                                <button onclick="document.getElementById('user-input').value='Simplify this';sendMessage()" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Simplify</button>
                                <button onclick="document.getElementById('user-input').value='Key Takeaways';sendMessage()" class="px-3 py-1 rounded-full bg-gray-50 text-xs text-gray-600 border hover:bg-gray-100">Key Takeaways</button>
                                <div class="flex gap-1 ml-2 border-l pl-2">
                                    <button class="p-1.5 text-gray-400 hover:text-green-500"><i class="fa-regular fa-thumbs-up"></i></button>
                                    <button class="p-1.5 text-gray-400 hover:text-red-500"><i class="fa-regular fa-thumbs-down"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`);
                
                if(state.history[0] !== text) {
                    state.history.unshift(text);
                    const histList = document.getElementById('history-list');
                    const btn = document.createElement('button');
                    btn.className = "w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-sm transition text-left text-gray-500 truncate";
                    btn.innerHTML = `<i class="fa-regular fa-message w-4"></i> ${text}`;
                    btn.onclick = () => { document.getElementById('user-input').value = text; sendMessage(); };
                    histList.prepend(btn);
                }

            } catch(err) { if(err.name !== 'AbortError') document.getElementById('loading').classList.add('hidden'); }
            finally { document.getElementById('send-btn').classList.remove('hidden'); document.getElementById('stop-btn').classList.add('hidden'); state.controller = null; }
            window.scrollTo(0, document.body.scrollHeight);
        }
    </script>
</body>
</html>
